<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Presto Embeddings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,300" rel="stylesheet" type="text/css">
    <link rel="icon" href="assets/NASA_Harvest_favicon.png">
    <link rel="stylesheet" type="text/css" rel="noopener" target="_blank" href="main.css">
  </head>
  
  <body>
    <!-- Header -->
    <div id="navbar">
        <a href="https://nasaharvest.github.io/">
            <div id="logo">
                <img src="assets/logo.png"/>
                <div id="logotext">
                <h1>NASA Harvest</h1>
                <h3>Machine Learning</h3>
                </div>
            </div>
        </a>
        <div class="menu">
        <a href="https://nasaharvest.github.io/">About</a>
        <a href="https://nasaharvest.github.io/#sessions">Sessions</a>
        <a href="https://nasaharvest.github.io/#profiles">Team</a>
        </div>
    </div>
    
    <div id="content">
        
        
        <h1 style="text-align: center; margin-block-end: 0">Presto Embeddings for Cropland Mapping</h1>
        <p style="text-align: center;">by Ivan Zvonkov, Gabriel Tseng, Hannah Kerner</p>
        <img src="assets/pipeline.png" alt="Presto Embeddings Pipeline" style="width: 100%;">
        <p>
            Geospatial embeddings offer a novel, efficient, and accessible way to map landscape features.
            <br> 
            In part 1 of this blog post, we show how to generate embeddings using a geospatial foundation model (Presto).
            <br>
            In part 2 we show that geospatial embeddings can be used to map cropland with high accuracy.
            <br><br>
            We have written and linked several Google Earth Engine scripts throughout the blog post,
            the scripts can also be accessed through this repository: 
            <br>
            <a href="https://code.earthengine.google.com/?accept_repo=users/izvonkov/presto">https://code.earthengine.google.com/?accept_repo=users/izvonkov/presto</a> 
            <br><br>
        </p>


        <details>
            <summary>üõ∞Ô∏è <strong>Part 1:</strong> Generating Presto Embeddings</summary>
            <h4>Why Generate Embeddings?</h4>
            <p>
                Presto geospatial embeddings provide a compressed representation of Earth Observation data, 
                enabling more efficient mapping and analysis. Embeddings are generated by using the Presto encoder
                to compress location information, optical imagery (Sentinel-2), radar imagery (Sentinel-1),  
                climatology data (ERA5), and elevation data (SRTM) over the course of a year. 
                Each embedding contains 128 features representing a single 10m<sup>2</sup> pixel on Earth.
                Embeddings can be used in place of raw Earth Observation data for various machine-learning tasks,
                such as classification, clustering, and anomaly detection. 
                In order to use embeddings they must first be generated for the time frame and area of interest.
                We provide an open-source pipeline to do this using Vertex AI and Google Earth Engine.
            </p>
            <h4>Generating Embeddings</h4>
            <p>
                The embedding generation pipeline consists of two steps:
                <ol>
                    <li>Deploying Presto to Google Cloud Vertex AI in Google Colab<br>
                        <a href="https://colab.research.google.com/github/nasaharvest/presto/blob/main/deploy/1_Presto_to_VertexAI.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></li>
                    <li>Using the ee.Model.fromVertexAi function in Google Earth Engine<br><a href="https://code.earthengine.google.com/1d196e8466506239c4780585c0e28d26">1_Generate_Embeddings</a></li>
                </ol>
                In step 1, we package the default Presto model into a TorchServe container.
                The container is deployed to a Google Cloud Vertex AI endpoint, which allows for scalable inference 
                using data from Google Earth Engine.
                <br><br>
                In step 2, we call the Vertex AI endpoint from Google Earth Engine, sending Earth observation data for our 
                time frame and area of interest to the deployed Presto model. Once inference is complete, the embeddings are
                saved as an Earth Engine asset.
                <br><br>
                Once predictions are made, you must <strong>undeploy your model</strong> to stop incurring further charges. 
                This can be done in the Vertex AI console or in the provided Google Colab notebook.

            </p>
            
            <h4>Cost Considerations</h4>
            <p>
                While Google Colab and Google Earth Engine (non-commercial) are free to use, 
                deploying Presto to Vertex AI and running large-scale inference incurs cloud costs.
                <br>The current cost formula is: 
                <strong style="background-color: pink">$5.37 - $10.14 / 1000 km<sup>2</sup></strong>.
                <br><br>
                The cost formula is a range due to scaling in Google Cloud. 
                Small regions will tend toward the higher range, 
                and larger regions, such as all of Togo, will tend towards the lower range.

            </p>    
            

            <h4>Case Study: Generating Embeddings for Togo</h4>
            <p>
            To test our pipeline, we generated embeddings for all of Togo (56,785 km<sup>2</sup>)
            for the time frame of March 2019 - March 2020.
            The embedding generation took 16 hours and cost $313.40. 
            The final Togo asset size was 128.8 GB.
            </p>
            <div class='click-zoom width2'> 
                <label>
                    <input type='checkbox' />
                        <img src='assets/Togo_cost.png' alt='Cost of Togo Embeddings' style="width: 100%;">
                </label>
            </div> 
            <div class='click-zoom width2'> 
                <label>
                    <input type='checkbox' />
                        <img src="assets/Togo_stats.png" alt="Asset Size"  style="width: 100%;">
                </label>
            </div> 
            <p>
                The asset can be accessed here:<br><a href="https://code.earthengine.google.com/?asset=users/izvonkov/Togo/Presto_embeddings_v2025_06_19">https://code.earthengine.google.com/?asset=users/izvonkov/Togo/Presto_embeddings_v2025_06_19</a>
                <br><br>
                It's important to note that Google Earth Engine has a default asset storage limit of 250 GB.
                <br>
                For larger assets, we recommend exploring 
                <a href="https://developers.google.com/earth-engine/Earth_Engine_asset_from_cloud_geotiff">Cloud GeoTiff-Backed Earth Engine Assets</a>.
            </p>

            <h4>Sanity Checking Embeddings</h4>
            <p>
                To verify that the embeddings contain meaningful information we cluster the embeddings 
                using k-means and visually compare the clusters to an existing land cover map (WorldCover 2020).
                <br>This requires just 9 lines of code: 
                <a href="https://code.earthengine.google.com/c90e3bcc3b26f2eaee125ccf7d105942">2_Kmeans_clustering_embeddings</a> 
            </p>
            <pre>
// Region of interest
var roi = ee.FeatureCollection("FAO/GAUL/2015/level2").filter(ee.Filter.eq('ADM0_NAME', 'Togo'));
Map.centerObject(roi, 7)

// Load and cluster embeddings
var embeddings = ee.Image("users/izvonkov/Togo/Presto_embeddings_v2025_06_19")
var training = embeddings.sample({region: roi, scale: 10, numPixels: 10000});
var trainedClusterer = ee.Clusterer.wekaKMeans(7).train(training);
var result = embeddings.cluster(trainedClusterer);
Map.addLayer(result.randomVisualizer(), {}, 'clusters');

// Display WorldCover
var WorldCover = ee.ImageCollection('ESA/WorldCover/v200').first().clip(roi)
Map.addLayer(WorldCover, {bands: ['Map']}, 'WorldCover')
            </pre>
            <div class='click-zoom' > 
                <label>
                    <input type='checkbox' />
                        <img src="assets/Togo_clusters.png" alt="Togo Clusters"  style="width: 90%;">
                </label>
            </div> 
            <p>
                We see that the clusters visually align well with the land cover map. 
                In particular, the green embedding cluster correlates very closely with built-up areas in the land cover map. 
                This suggests that the embeddings capture meaningful information about the land cover in Togo 
                and can be used for further mapping and analysis.
            </p>    
        </details>
        
        <br><br>
        
        <details>
            <summary>üåæ <strong>Part 2</strong>: Mapping Cropland in Togo using Embeddings</summary>
            <h4>Why use embeddings for mapping?</h4>
            <p>
                Embeddings are a compressed version of processed Earth Observation data. 
                So using embeddings for mapping will be more computationally efficient compared
                to using traditional Earth Observation data. 
                Using embeddings also makes it possible to skip data processing (such as cloud processing) altogether.
            </p>
            
            <h4>How does it work?</h4>
            <p>
                A traditional mapping approach usually involves the following:
                <ol>
                    <li>Loading Earth Observation data for the region of interest.</li>
                    <li>Loading labeled points representing the classes to be mapped.</li>
                    <li>Creating a training dataset by combining labeled points with Earth Observation data.</li>
                    <li>Training a classifier (e.g. Random Forest) on the training dataset.</li>
                    <li>Classifying all the Earth Observation data using the trained classifier.</li>
                </ol>
                Replace <strong>Earth Observation data</strong> with <strong>embeddings</strong> 
                and the result is an embedding-based mapping approach:
                <ol>
                    <li>Loading embeddings for the region of interest.</li>
                    <li>Loading labeled points representing the classes to be mapped.</li>
                    <li>Creating a training dataset by combining labeled points with embeddings.</li>
                    <li>Training a classifier (e.g. Random Forest) on the training dataset.</li>
                    <li>Classifying all the embeddings using the trained classifier.</li>
                </ol>
            </p>

            <h4>Mapping Cropland in Togo</h4>

            We need just 12 lines of code to map cropland using embeddings in Togo: 
            <a href="https://code.earthengine.google.com/a022104b3793e63dcb9459b97886c7d9">3_Togo_cropland_presto</a>.
            <br>
            We use a random forest classifier with 100 trees. 
            We initially saw a lot of crops in the output and so used a probability threshold of 0.7.
            <pre>
// 1. Load embeddings for region of interest
var roi = ee.FeatureCollection("FAO/GAUL/2015/level2").filter("ADM0_NAME=='Togo'");
Map.centerObject(roi, 7)
var embeddings = ee.Image("users/izvonkov/Togo/Presto_embeddings_v2025_06_19")

// 2. Load Togo points
var points = ee.FeatureCollection("users/izvonkov/Togo/points_2019")
var trainingPoints = points.filter(ee.Filter.eq("subset", "training"))

// 3. Create training dataset (training points + embeddings)
var trainingSet = embeddings.sampleRegions(trainingPoints, ["is_crop"], 10 )

// 4. Train a classifier (100 trees)
var model = ee.Classifier.smileRandomForest(100).setOutputMode('probability')
var trainedModel = model.train(trainingSet, 'is_crop', embeddings.bandNames());

// 5. Classify embeddings using trained model
var croplandPreds = embeddings.classify(trainedModel).clip(roi)
var croplandMap = croplandPreds.gte(0.7).rename("map_crop")

// 6. Display cropland maps
var classVis = {min: 0, max: 1.0, palette: ['yellow', 'green']}
Map.addLayer(croplandMap, classVis, 'Presto Embeddings Based Cropland');
            </pre>
            <p style="text-align: center">
                The resulting cropland map is generated in less than 5 seconds:
            </p>
            <div class='click-zoom' style="width: 10em; margin-left: 20em"> 
                <label>
                    <input type='checkbox' />
                        <img src="assets/Togo_cropland_Presto.png" alt="Togo Cropland"  style="width: 100%;">
                </label>
            </div> 
            
            
            <h4>Alternative Embeddings: Google DeepMind</h4>

            <p>
                Google DeepMind recently released their own pixel-level 
                <a href="https://developers.google.com/earth-engine/datasets/catalog/GOOGLE_SATELLITE_EMBEDDING_V1_ANNUAL">embeddings</a>.
                <br>Here are some similarities and differences between the two:
            </p>
                <table>
                    <tr>
                        <th></th>
                        <th>Presto Embeddings</th>
                        <th>DeepMind Embeddings</th>
                    </tr>
                    <tr>
                        <th>Earth Engine Code</th>
                        <td>
                            <pre style="font-size: 0.5em">
<strong>ee.Image(</strong>"users/izvonkov/Togo/Presto_embeddings_v2025_06_19"<strong>)</strong></pre>
                        </td>
                        <td>
                            <pre style="font-size: 0.5em">
<strong>ee.ImageCollection(</strong>"GOOGLE/SATELLITE_EMBEDDING/V1/ANNUAL"<strong>)</strong>
    <strong>.filterDate(</strong>"2021-01-01", "2022-01-01"<strong>)</strong>
    <strong>.mosaic()</strong>
    <strong>.clip(</strong>roi<strong>)</strong></pre>
                        </td>
                    </tr>
                    <tr>
                        <th>Data Sources</th>
                        <td>Sentinel-1, Sentinel-2, ERA5, SRTM</td>
                        <td>Optical, radar, LiDAR, and other sources (Brown, Kazmierski, Pasquarella et al., in review)</td>
                    </tr>
                    <tr>
                        <th>Timeframe</th>
                        <td>March 2019 - March 2020</td>
                        <td>January 2021 - January 2022<br>[earlier than 2021 not available]</td>
                    </tr>
                    <tr>
                        <th>Embedding Size</th>
                        <td>128 values</td>
                        <td>64 values</td>
                    </tr>
                    <tr>
                        <th>Scale</th>
                        <td>10 m<sup>2</sup></td>
                        <td>10 m<sup>2</sup></td>
                    </tr>
                    
                    <tr>
                        <th>Data Type</th>
                        <td><pre>uint16</pre></td>
                        <td><pre>double</pre></td>
                    </tr>
                    <tr>
                        <th>Bytes per pixel</th>
                        <td>256</td>
                        <td>512</td>
                    </tr>
                </table> 
            <p>
            We create an alternative cropland map with Google DeepMind embeddings by simply substituting:
           <pre>
<strong>ee.Image(</strong>"users/izvonkov/Togo/Presto_embeddings_v2025_06_19"<strong>)</strong></pre>
            with 
            <pre>
<strong>ee.ImageCollection(</strong>"GOOGLE/SATELLITE_EMBEDDING/V1/ANNUAL"<strong>)</strong>
    <strong>.filterDate(</strong>"2021-01-01", "2022-01-01"<strong>)</strong>
    <strong>.mosaic()</strong>
    <strong>.clip(</strong>roi<strong>)</strong></pre>
            Here is the updated script on Google Earth Engine:
            <a href="https://code.earthengine.google.com/fa52c369fd0d6e5336e9686902972b49">4_Togo_cropland_deepmind</a>.
            </p>
            
            <h4>Visual Assessment and Comparison</h4>
            <p>
                One way of comparing embeddings is visually assessing and comparing the generated cropland maps.
                We display the embedding-generated maps below, in addition to the best available cropland maps in Togo.
                <br><br>
                Green represents crops and yellow is everything else. The displayed maps are:
                <ol>
                    <li>a cropland map derived from the WorldCover land cover map,</li>
                    <li>the GLAD cropland map,</li>
                    <li>the Presto embedding-based cropland map,</li>
                    <li>the DeepMind embedding-based cropland map.</li>
                </ol>
            </p>
            <div class='click-zoom width4'> 
                <label>
                    <input type='checkbox' />
                    <img src='assets/Togo_cropland_WorldCover.png' alt='Togo Cropland WorldCover'>
                </label>
                <p class="textRight800">1. WorldCover<br><br></p>
            </div>

            <div class='click-zoom width4'> 
                <label>
                    <input type='checkbox' />
                    <img src='assets/Togo_cropland_GLAD.png' alt='Togo Cropland GLAD'>
                </label>
                <p class="textRight800">2. GLAD<br><br></p>
            </div>

            <div class='click-zoom width4'> 
                <label>
                    <input type='checkbox' />
                    <img src='assets/Togo_cropland_Presto.png' alt='Togo Cropland Presto'>
                </label>
                <p class="textRight800">3. Presto<br>Embeddings</p>
            </div> 

            <div class='click-zoom width4'> 
                
                <label>
                    <input type='checkbox' />
                    <img src='assets/Togo_cropland_DeepMind.png' alt='Togo Cropland DeepMind'>
                </label>
                <p class="textRight800">4. DeepMind<br>Embeddings</p>
            </div>

            <p>
                Observations from examining the maps from a country level:
                <ul>
                    <li>Presto and DeepMind embedding-based have a similar cropland amount and distribution</li>
                    <li>Presto and DeepMind embedding-based show more crops than WorldCover</li>
                    <li>The South of Togo is where all maps have differences</li>
                </ul>
                This Google Earth Engine script allows flexible map comparison at different zoom levels:
                <a href="https://code.earthengine.google.com/29b52c0bfed621f07c29798a966fb63b">5_Togo_cropland_comparison</a>
                
                For demonstration purposes, we zoom into the South West of Togo.
                Here are some screenshots from a window centered on the coordinate: (0.84445, 6.46924):
            
            </p>

            <!-- Slideshow container -->
            <div class="slideshow-container">

                <div class="mySlides click-zoom">
                    <label>
                        <input type='checkbox' />
                        <img src='assets/Togo_zoom_satellite.png' alt="Togo Cropland Zoom Satellite" />
                    </label>
                    <div class="numbertext">1 / 5</div>
                    <div class="text">Satellite view in Google Earth Engine</div>
                </div>

                <div class="mySlides click-zoom">
                    <label>
                        <input type='checkbox' />
                        <img src='assets/Togo_zoom_WorldCover.png' alt="Togo Cropland Zoom WorldCover" />
                    </label>
                    <div class="numbertext">2 / 5</div>
                    <div class="text">WorldCover Cropland</div>
                </div>

                <div class="mySlides click-zoom">
                    <label>
                        <input type='checkbox' />
                        <img src='assets/Togo_zoom_GLAD.png' alt="Togo Cropland Zoom GLAD " />
                    </label>
                    <div class="numbertext">3 / 5</div>
                    <div class="text">GLAD Cropland</div>
                </div>

                <div class="mySlides click-zoom">
                    <label>
                        <input type='checkbox' />
                        <img src='assets/Togo_zoom_Presto.png' alt="Togo Cropland Zoom Presto" />
                    </label>
                    <div class="numbertext">4 / 5</div>
                    <div class="text">Presto Embeddings-based Cropland</div>
                </div>

                <div class="mySlides click-zoom">
                    <label>
                        <input type='checkbox' />
                        <img src='assets/Togo_zoom_DeepMind.png' alt="Togo Cropland Zoom DeepMind" />
                    </label>
                    <div class="numbertext">5 / 5</div>
                    <div class="text">DeepMind Embeddings-based Cropland</div>
                </div>

                <!-- Next and previous buttons -->
                <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                <a class="next" onclick="plusSlides(1)">&#10095;</a>
            </div>
            <br>

            <!-- The dots/circles -->
            <div style="text-align:center">
            <span class="dot" onclick="currentSlide(1)"></span>
            <span class="dot" onclick="currentSlide(2)"></span>
            <span class="dot" onclick="currentSlide(3)"></span>
            <span class="dot" onclick="currentSlide(4)"></span>
            <span class="dot" onclick="currentSlide(5)"></span>
            </div>
            <p>
                <ul>
                    <li>All maps with the exception of GLAD correctly identify built-up areas as non-crop (yellow)</li>
                    <li>Embedding-based maps appear to classify more cropland (green) correctly</li>
                    <li>The DeepMind embedding-based map over predicts crops in some shrub/tree areas</li>
                    <li>Presto embedding-based map visually accurately identifies many of the tree areas as non-crop</li>
                </ul>
            </p>

            <h4>Metrics Assessment and Comparison</h4>
            <p>
                To get a more comprehensive understanding of the map quality 
                we conducted an accuracy assessment using the Togo test set from CropHarvest.
                It's important to note that Presto was benchmarked against CropHarvest.
            </p>

            <table style="text-align: center;">
                <tr>
                    <th style="text-align: left">Metric / Cropland Map</th>
                    <th>WorldCover</th>
                    <th>GLAD</th>
                    <th>Presto<br>Embeddings</th>
                    <th>DeepMind<br>Embeddings</th>
                </tr>
                <tr>
                    <td style="text-align: left">Overall Accuracy</td>
                    <td>0.880</td>
                    <td>0.859</td>
                    <th><span style="color: blue">0.897</span></th>
                    <td>0.859</td>
                </tr>
                <tr>
                    <td style="text-align: left">User's Accuracy</td>
                    <th><span style="color: blue">0.892</span></th>
                    <td>0.821</td>
                    <td>0.833</td>
                    <td>0.745</td>
                </tr>
                <tr>
                    <td style="text-align: left">Producer's Accuracy</td>
                    <td>0.647</td>
                    <td>0.627</td>
                    <th><span style="color: blue">0.784</span></th>
                    <td>0.745</td>
                </tr>
                <tr>
                    <td style="text-align: left">F1-Score</td>
                    <td>0.750</td>
                    <td>0.711</td>
                    <th><span style="color: blue">0.808</span></th>
                    <td>0.745</td>
                </tr>
            </table>
            <p>Script for assessment: <a href="https://code.earthengine.google.com/52d99816df0fc7b2cda3648cf7f708d5">6_Togo_cropland_embeddings_metrics</a></p>

            <h4>Concluding Thoughts</h4>
            <p>
            We show that using Presto embeddings for cropland mapping is simple, quick, and effective.
            Our results indicate the potential for using embeddings for more effective mapping 
            in different regions and for different use cases. 
            </p>
        </details>
        <br>
        <br>
        <hr>
        <p>This work was supported by the NASA Harvest Consortium.</p>
        
    </div>
     
    <script>
let slideIndex = 1;
showSlides(slideIndex);

function plusSlides(n) {
  showSlides(slideIndex += n);
}

function currentSlide(n) {
  showSlides(slideIndex = n);
}

function showSlides(n) {
  let i;
  let slides = document.getElementsByClassName("mySlides");
  let dots = document.getElementsByClassName("dot");
  if (n > slides.length) {slideIndex = 1}    
  if (n < 1) {slideIndex = slides.length}
  for (i = 0; i < slides.length; i++) {
    slides[i].style.display = "none";  
  }
  for (i = 0; i < dots.length; i++) {
    dots[i].className = dots[i].className.replace(" active", "");
  }
  slides[slideIndex-1].style.display = "block";  
  dots[slideIndex-1].className += " active";
}
</script>


  </body>
</html>
